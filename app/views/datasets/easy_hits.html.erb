<div class="row">
  <div class="col l4 m8 s12">
    <div class="card cyan darken-1">
      <div class="card-content white-text">
        <form action="/datasets/easy_hits" method="post">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">

          <div class="row">
            <div class="col s11 left">
              <span class="card-title">Cargar hit (manual)</span>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12">
              <input id="hit_date" name="hit[date]" type="date" required style="background:white; color:black; padding-left:8px;">
              <label for="hit_date" class="black-text">Fecha</label>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12">
              <input id="hit_location_label" type="text" list="location_list" autocomplete="off" required style="background:white; color:black; padding-left:8px;">
              <label for="hit_location_label" class="black-text" style="padding-left: 12px">Municipio o Estado</label>

              <input type="hidden" id="hit_location_code" name="hit[location_code]" />

              <datalist id="location_list">
                <% @county_options.each do |opt| %>
                  <option value="<%= opt[:label] %>" data-code="<%= opt[:code] %>"></option>
                <% end %>
                <% @state_options.each do |opt| %>
                  <option value="<%= opt[:label] %>" data-code="<%= opt[:code] %>"></option>
                <% end %>
              </datalist>

              <small style="opacity:0.9;">Ej: Tequila, Jal. (o un Estado)</small>
            </div>
          </div>

          <script type="text/javascript" nonce="<%= csp_nonce %>">
            function bindEasyHitsLocation() {
              const input = document.getElementById("hit_location_label");
              const hidden = document.getElementById("hit_location_code");
              const list = document.getElementById("location_list");
              if (!input || !hidden || !list) return;

              const sync = () => {
                const v = input.value;
                const opt = Array.from(list.options).find(o => o.value === v);
                hidden.value = opt ? (opt.dataset.code || "") : "";
              };

              input.addEventListener("input", sync);
              input.addEventListener("change", sync);
              input.addEventListener("blur", sync);
            }

            document.addEventListener("DOMContentLoaded", bindEasyHitsLocation);
            document.addEventListener("turbo:load", bindEasyHitsLocation);
            document.addEventListener("turbolinks:load", bindEasyHitsLocation);
          </script>

          <div class="row">
            <div class="input-field col s12">
              <input id="hit_title" name="hit[title]" type="text" required style="background:white; color:black; padding-left:8px;">
              <label for="hit_title" class="black-text" style="padding-left: 12px;">Título</label>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12">
              <input id="hit_link" name="hit[link]" type="text" required style="background:white; color:black; padding-left:8px;">
              <label for="hit_link" class="black-text" style="padding-left: 12px">Link</label>
            </div>
          </div>

          <div class="card-action">
            <button type="submit" class="btn waves-effect waves-light">Guardar hit</button>
          </div>
        </form>
      </div>
    </div>
    <datalist id="members_list">
      <% Member.joins(:hits).distinct.order(:id).each do |m| %>
        <option value="<%= m.fullname %>"></option>
      <% end %>
    </datalist>
    <div class="card">
      <div class="card-content">
        <span class="card-title">Últimos hit (creado o intentado)</span>

        <% attempts = (session[:easy_hit_attempts] || []) %>

        <% if attempts.empty? %>
          <p style="opacity:0.7;">Aún no hay registros.</p>
        <% else %>
          <ul class="collapsible">
            <% attempts.each_with_index do |a, idx| %>
              <% town = a["town_id"].present? ? Town.find_by(id: a["town_id"]) : nil %>
              <% unless town.county.name == "Sin definir" %>
                <% place = town ? "#{town.county.name} (#{town.county.full_code})" : "—" %>
              <% else %>
                <% place = town ? "#{town.county.state.name}" : "—" %>
              <% end %>

              <li>
                <div class="collapsible-header">
                  <div class="row">
                    <div class="col s12">
                      <% if a["status"] == "ok" %>
                        <i class="material-icons">check_circle</i>
                      <% else %>
                        <i class="material-icons">error</i>
                      <% end %>

                      <span style="margin-right:10px;"><strong><%= a["legacy_id"].presence || "—" %></strong></span>
                    </div>
                    <div class="col s12">
                      <span style="opacity:0.8;"><%= a["title"].presence || "(sin título)" %></span>
                    </div>
                  </div>
                </div>

                <div class="collapsible-body">
                  <p><strong>Lugar:</strong> <%= place %></p>
                  <p><strong>Link:</strong> <% if a["link"].present? %><a href="<%= a["link"] %>" target="_blank"><%= a["link"] %></a><% else %>—<% end %></p>

                  <% if a["status"] != "ok" %>
                    <p style="color:#b71c1c;"><strong>Error:</strong> <%= a["message"].presence || "No se pudo crear" %></p>
                  <% end %>
                <br>
                  <% hit = Hit.find_by(legacy_id: a["legacy_id"]) %>
                  <% if hit.present? %>
                    <% if hit.plain_text != nil %>
                      <div style="margin-top:15px;">
                        <form action="/datasets/add_members_to_hits" method="post">
                          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                          <input type="hidden" name="hit_id" value="<%= hit.id %>">
                          <div class="members-fields" data-hit="<%= hit.id %>">
                            <div class="member-field input-field">
                              <input type="text" class="member-autocomplete" list="members_list" autocomplete="off" placeholder="Selecciona un member">
                              <input type="hidden" class="member-id-hidden" name="member_ids[]">
                            </div>
                          </div>

                          <a href="#!" class="btn-small add-member-field" data-hit="<%= hit.id %>" style="margin-top:8px;">
                            <i class="material-icons">add</i>
                          </a>
                          <button type="submit" class="btn-small" style="margin-top:8px;">Submit</button>
                        </form>
                      </div>
                    <% elsif hit.backup_source == "pdf" %>
                      <div style="margin-top:15px;">
                        <p style="opacity:0.8; margin-bottom:10px;">
                          Respaldo en PDF: no hay validación automática en texto.
                        </p>

                        <form action="/datasets/add_members_to_hits_pdf" method="post" class="pdf-members-form">
                          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                          <input type="hidden" name="hit_id" value="<%= hit.id %>">

                          <div class="members-fields" data-hit="<%= hit.id %>">
                            <div class="member-field input-field">
                              <input type="text" class="member-autocomplete" list="members_list" autocomplete="off" placeholder="Selecciona un member">
                              <input type="hidden" class="member-id-hidden" name="member_ids[]">
                            </div>
                          </div>

                          <a href="#!" class="btn-small add-member-field" data-hit="<%= hit.id %>" style="margin-top:8px;">
                            <i class="material-icons">add</i>
                          </a>

                          <button type="button" class="btn-small modal-trigger pdf-confirm-btn" data-target="pdf-confirm-modal" style="margin-top:8px;">
                            Submit
                          </button>
                        </form>
                      </div>
                    <% else %>
                      <div style="margin-top:15px;">
                        <h6 class="center-align"style="color: #ef4e50">Hit sin respaldo</h6>
                      </div>
                      <%# dentro del bloque "Hit sin respaldo" %>
                      <div style="margin-top:12px;">
                        <form action="/datasets/upload_hit_pdf_snapshot" method="post" enctype="multipart/form-data">
                          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                          <input type="hidden" name="hit_id" value="<%= hit.id %>">

                          <input type="file"
                                 id="easy_pdf_file_<%= hit.id %>"
                                 name="pdf_snapshot"
                                 accept="application/pdf"
                                 required>

                          <div id="easy_pdf_name_<%= hit.id %>"
                               style="border:1px solid #EF4E50; border-radius:0; padding:0.5rem;">
                            Haz clic aquí para seleccionar el PDF…
                          </div>
                          <button type="submit" class="btn">Subir respaldo</button>
                        </form>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>
    </div>

    <script nonce="<%= csp_nonce %>">
      document.addEventListener("DOMContentLoaded", function() {
        var elems = document.querySelectorAll(".collapsible");
        if (window.M && M.Collapsible) M.Collapsible.init(elems);
      });
      document.addEventListener("turbo:load", function() {
        var elems = document.querySelectorAll(".collapsible");
        if (window.M && M.Collapsible) M.Collapsible.init(elems);
      });
    </script>
    <script nonce="<%= csp_nonce %>">
      function bindAddMemberButtons() {
        document.querySelectorAll(".add-member-field").forEach((btn) => {
          if (btn.dataset.bound === "1") return;
          btn.dataset.bound = "1";

          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const hitId = btn.dataset.hit;
            const container = document.querySelector(`.members-fields[data-hit="${hitId}"]`);
            if (!container) return;

            const first = container.querySelector(".member-field");
            if (!first) return;

            const clone = first.cloneNode(true);
            // limpia valores
            const vis = clone.querySelector(".member-autocomplete");
            const hid = clone.querySelector(".member-id-hidden");
            if (vis) vis.value = "";
            if (hid) hid.value = "";

            container.appendChild(clone);

            // si tienes bind del autocomplete (aunque lo de acentos lo veamos después),
            // re-bindea listeners para el nuevo campo:
            if (typeof bindMemberAutocomplete === "function") bindMemberAutocomplete();
          });
        });
      }

      document.addEventListener("DOMContentLoaded", bindAddMemberButtons);
      document.addEventListener("turbo:load", bindAddMemberButtons);
      document.addEventListener("turbolinks:load", bindAddMemberButtons);
    </script>


  </div>

  <!-- Listado falta respaldo -->
  <div class="col l8 m12 s12">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Miembros sin respaldo</span>
        <p style="margin-top:-8px; opacity:0.7;">
          Total: <%= @members_falta_respaldo.size %>
        </p>

        <div style="max-height:520px; overflow-y:auto; margin-top:10px;">
          <ul class="collection">
            <% @members_falta_respaldo.limit(30).each do |m| %>
              <li class="collection-item" style="padding:0;">
                <ul class="collapsible" style="margin:0; box-shadow:none;">
                  <li>
                    <div class="collapsible-header" style="display:flex; align-items:center; justify-content:space-between;">
                      <div>
                        <strong><%= m.id %></strong> — <%= m.fullname %> - <%= m.organization.name %>
                      </div>

                      <a
                        href="#!"
                        class="secondary-content modal-trigger easy-member-delete-trigger"
                        data-target="easy-member-delete-modal"
                        data-member-id="<%= m.id %>"
                        data-member-name="<%= m.fullname %>"
                        style="margin-left:12px;"
                      >
                        <i class="material-icons red-text">close</i>
                      </a>
                    </div>

                    <div class="collapsible-body member_edit" style="padding:16px;">
                      <div class="row grey lighten-2" style="padding:10px;">
                        <%= form_with model: m, url: update_member_name_path(m), local: true do |f| %>
                          <div class="input-field col l3 m4 s6">
                            <%= f.label :firstname, "Nombre" %>
                            <%= f.text_field :firstname, class: "validate", value: m.firstname %>
                          </div>
                          <div class="input-field col l3 m4 s6">
                            <%= f.label :lastname1, "Apellido paterno" %>
                            <%= f.text_field :lastname1, class: "validate", value: m.lastname1 %>
                          </div>
                          <div class="input-field col l3 m4 s6">
                            <%= f.label :lastname2, "Apellido materno" %>
                            <%= f.text_field :lastname2, class: "validate", value: m.lastname2 %>
                          </div>
                          <div class="input-field col l3 m4 s6">
                            <%= f.label :gender, "Género", class: "active" %>
                            <%= f.select :gender,
                                  options_for_select([
                                    ["MASCULINO", "MASCULINO"],
                                    ["FEMENINO", "FEMENINO"],
                                    ["No identificado", "No identificado"]
                                  ], selected: m.gender.presence || "No identificado"),
                                  {},
                                  class: "browser-default" %>
                          </div>
                          <div class="input-field col l3 m4 s6">
                            <%= f.label :role_id, "Rol", class: "active" %>
                            <%= f.select :role_id,
                                  Role.where(name: @all_roles).order(:name).pluck(:name, :id),
                                  { include_blank: "Selecciona un rol" },
                                  class: "browser-default" %>
                          </div>

                          <% selected_org_id = m.criminal_link_id.presence || m.organization_id %>

                          <div class="input-field col l3 m4 s6">
                            <%= label_tag :org_target_id, "Organización", class: "active" %>

                            <% cartels_options =
                                @cartels.map do |c|
                                  if c.is_a?(Array)
                                    [c[0], c[1]]
                                  else
                                    [c.name, c.id]
                                  end
                                end
                            %>

                            <%= select_tag :org_target_id,
                                  options_for_select(cartels_options, selected_org_id),
                                  include_blank: "Selecciona organización",
                                  class: "browser-default" %>
                          </div>
                          <div class="input-field col l3 m4 s6">
                            <%= f.label :involved, "Estatus", class: "active" %>
                            <%= f.select :involved,
                                  options_for_select([
                                    ["SEÑALADO", "true"],
                                    ["EXPUESTO", "false"],
                                  ], selected: m.involved),
                                  {},
                                  class: "browser-default" %>
                          </div>
                          <div class="col l3 m4 s6" style="margin-top:10px;">
                            <%= hidden_field_tag :return_to, "easy_hits" %>
                            <%= f.submit "Actualizar", class: "btn blue" %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </li>
                </ul>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
    <div>
      MSG=<%= @message.inspect %> | OK=<%= @load_success.inspect %>
    </div>
  </div>
</div>

<script nonce="<%= csp_nonce %>">
  function norm(s) {
    return (s || "")
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  // Diccionario: "nombre normalizado" => id
  const MEMBER_NAME_TO_ID = <%= raw(
    Member.joins(:hits).distinct.order(:id).map { |m|
      key = ActiveSupport::Inflector.transliterate(m.fullname.to_s)
        .downcase.gsub(/[^a-z0-9\s]/, " ").squeeze(" ").strip
      [key, m.id]
    }.to_h.to_json
  ) %>;

  function bindMemberAutocomplete() {
    document.querySelectorAll(".member-autocomplete").forEach((input) => {
      const hidden = input.parentElement.querySelector(".member-id-hidden");
      if (!hidden) return;

      const sync = () => {
        const key = norm(input.value);
        hidden.value = MEMBER_NAME_TO_ID[key] ? String(MEMBER_NAME_TO_ID[key]) : "";
      };

      input.addEventListener("input", sync);
      input.addEventListener("change", sync);
      input.addEventListener("blur", sync);
      sync();
    });
  }

  document.addEventListener("DOMContentLoaded", bindMemberAutocomplete);
  document.addEventListener("turbo:load", bindMemberAutocomplete);
  document.addEventListener("turbolinks:load", bindMemberAutocomplete);
</script>

<!-- Modal: Confirmar eliminación de member (easy hits) -->
<div id="easy-member-delete-modal" class="modal">
  <div class="modal-content">
    <h5>Advertencia</h5>
    <p>Si continúas, se eliminará este registro.</p>
    <p style="margin-top:12px;">
      <strong>ID:</strong> <span id="easy-member-delete-id">—</span><br>
      <strong>Nombre:</strong> <span id="easy-member-delete-name">—</span>
    </p>

    <form id="easy-member-delete-form" action="/datasets/destroy_easy_member" method="post" style="margin-top:18px;">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="hidden" name="member_id" id="easy-member-delete-member-id" value="">
    </form>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Cancelar</a>
    <a href="#!" id="easy-member-delete-continue" class="btn red">Continuar</a>
  </div>
</div>

<script nonce="<%= csp_nonce %>">
  function initEasyMemberDeleteFlow() {
    // init modals (Materialize)
    const modals = document.querySelectorAll(".modal");
    if (window.M && M.Modal) M.Modal.init(modals);

    document.querySelectorAll(".easy-member-delete-trigger").forEach((btn) => {
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", () => {
        const id = btn.dataset.memberId || "";
        const name = btn.dataset.memberName || "";

        const idSpan = document.getElementById("easy-member-delete-id");
        const nameSpan = document.getElementById("easy-member-delete-name");
        const hidden = document.getElementById("easy-member-delete-member-id");

        if (idSpan) idSpan.textContent = id;
        if (nameSpan) nameSpan.textContent = name;
        if (hidden) hidden.value = id;

        const modalEl = document.getElementById("easy-member-delete-modal");
        if (modalEl && window.M && M.Modal) {
          const instance = M.Modal.getInstance(modalEl) || M.Modal.init(modalEl);
          instance.open();
        }
      });
    });

    const cont = document.getElementById("easy-member-delete-continue");
    if (cont && cont.dataset.bound !== "1") {
      cont.dataset.bound = "1";
      cont.addEventListener("click", () => {
        const form = document.getElementById("easy-member-delete-form");
        if (form) form.submit();
      });
    }
  }

  document.addEventListener("DOMContentLoaded", initEasyMemberDeleteFlow);
  document.addEventListener("turbo:load", initEasyMemberDeleteFlow);
  document.addEventListener("turbolinks:load", initEasyMemberDeleteFlow);
</script>

<div id="pdf-confirm-modal" class="modal">
  <div class="modal-content">
    <h5>Respaldo en PDF</h5>
    <p>El respaldo está en formato PDF. Por favor, verifica que los siguientes nombres aparezcan en el archivo correspondiente:</p>
    <ul id="pdf-confirm-names" class="collection"></ul>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Cancelar</a>
    <a href="#!" id="pdf-confirm-continue" class="btn">Continuar</a>
  </div>
</div>

<script nonce="<%= csp_nonce %>">
  function initPdfConfirmFlow() {
    // init modal (Materialize)
    const modals = document.querySelectorAll(".modal");
    if (window.M && M.Modal) M.Modal.init(modals);

    let pendingForm = null;

    document.querySelectorAll(".pdf-confirm-btn").forEach((btn) => {
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";

      btn.addEventListener("click", () => {
        pendingForm = btn.closest("form");
        if (!pendingForm) return;

        // construye lista de nombres (texto visible) a partir de inputs member-autocomplete
        const names = Array.from(pendingForm.querySelectorAll(".member-autocomplete"))
          .map(i => (i.value || "").trim())
          .filter(v => v.length > 0);

        const ul = document.getElementById("pdf-confirm-names");
        ul.innerHTML = "";
        names.forEach((n) => {
          const li = document.createElement("li");
          li.className = "collection-item";
          li.textContent = n;
          ul.appendChild(li);
        });

        // abre modal
        const modalEl = document.getElementById("pdf-confirm-modal");
        if (window.M && M.Modal) {
          const instance = M.Modal.getInstance(modalEl) || M.Modal.init(modalEl);
          instance.open();
        }
      });
    });

    const cont = document.getElementById("pdf-confirm-continue");
    if (cont && cont.dataset.bound !== "1") {
      cont.dataset.bound = "1";
      cont.addEventListener("click", () => {
        if (pendingForm) pendingForm.submit(); // ahora sí hace el POST
      });
    }
  }

  document.addEventListener("DOMContentLoaded", initPdfConfirmFlow);
  document.addEventListener("turbo:load", initPdfConfirmFlow);
  document.addEventListener("turbolinks:load", initPdfConfirmFlow);
</script>
<script nonce="<%= csp_nonce %>">
  function bindEasyPdfFilePathClicks() {
    document.querySelectorAll('.file-path[data-file-id]').forEach((fp) => {
      if (fp.dataset.bound === "1") return;
      fp.dataset.bound = "1";

      fp.addEventListener('click', () => {
        const id = fp.dataset.fileId;
        const fileInput = document.getElementById(id);
        if (fileInput) fileInput.click();
      });
    });
  }

  document.addEventListener('DOMContentLoaded', bindEasyPdfFilePathClicks);
  document.addEventListener('turbo:load', bindEasyPdfFilePathClicks);
  document.addEventListener('turbolinks:load', bindEasyPdfFilePathClicks);
</script>

<script nonce="<%= csp_nonce %>">
  (function () {
    function bindEasyPdfNames() {
      document.querySelectorAll('input[type="file"][id^="easy_pdf_file_"]').forEach((inp) => {
        if (inp.dataset.bound === "1") return;
        inp.dataset.bound = "1";

        inp.addEventListener("change", () => {
          const id = inp.id.replace("easy_pdf_file_", "");
          const box = document.getElementById("easy_pdf_name_" + id);
          if (!box) return;

          const file = inp.files && inp.files[0];
          box.textContent = file ? file.name : "Haz clic aquí para seleccionar el PDF…";
        });

        // opcional: click en el cuadro rojo abre selector
        const id = inp.id.replace("easy_pdf_file_", "");
        const box = document.getElementById("easy_pdf_name_" + id);
        if (box && box.dataset.bound !== "1") {
          box.dataset.bound = "1";
          box.style.cursor = "pointer";
          box.addEventListener("click", () => inp.click());
        }
      });
    }

    document.addEventListener("DOMContentLoaded", bindEasyPdfNames);
    document.addEventListener("turbo:load", bindEasyPdfNames);
    document.addEventListener("turbolinks:load", bindEasyPdfNames);
  })();
</script>