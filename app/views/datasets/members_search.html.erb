<style type="text/css">	
/* Ajusta estos 3 valores a tu layout real */
:root{
  --header-offset: 150px;  /* altura de tu header/top spacing */
  --footer-offset: 90px;   /* altura del footer rojo aprox */
  --bottom-gap: 20px;      /* separaci√≥n extra arriba del footer */
}

#queries-tabs a{
  font-size: 1.15em;          /* hereda */
  font-weight: 300;
}

/* Asegura que el contenido del tab historial siempre sea flex-col */
#tab-historial{
  display: flex;
  flex-direction: column;
  min-height: 0;
  height: 100%;
}

/* Asegura que el scroll sea el √∫nico que crece */
#tab-historial .queries-panel__scroll{
  flex: 1 1 auto;
  min-height: 0;
}

/* La paginaci√≥n nunca crece ni entra al scroll */
#tab-historial .queries-panel__pagination{
  flex: 0 0 auto;
}

.queries-panel{
  overflow: hidden; /* evita que el contenido empuje la columna */
}

.queries-panel__card{
  height: calc(100vh - var(--header-offset) - var(--footer-offset) - var(--bottom-gap));
  margin-bottom: var(--bottom-gap);  /* queda separado del footer */
  display: flex;
  flex-direction: column;
  overflow: hidden; /* el card NO crece */
  min-height: 0;    /* clave con flex */
  align-items: stretch;
}

.queries-panel__content{
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;
}

.queries-panel__scroll{
  overflow-y: auto;
  overflow-x: hidden;
  min-height: 0;
  flex: 1 1 auto;
}

/* CLAVE: empuja la paginaci√≥n al fondo aunque haya poco contenido */
.queries-panel__pagination{
  margin-top: auto;
  flex: 0 0 auto;
  padding: 20px 0 20px 0;
  background: #fff;
  border-top: none;
}

/* el card-content debe poder encogerse dentro del flex */
#outcome-card { min-height: 0; }
<%# #outcome-card .queries-panel__content { min-height: 0; overflow-y: auto; overflow-x: hidden; } %>

	.collapsible.popout > li {
  box-shadow: none !important;
  margin: 0 !important;
  border: none !important;
}
  .clave-boton {
    min-width: 110px;
    text-align: center;
    padding: 4px 8px;
    font-size: 13px;
    background-color: #f0f0f0;
    color: #33333C;
    border-radius: 4px;
  }

  .clave-boton:hover {
    background-color: #e0e0e0;
  }

 a {
  color: inherit;
  text-decoration: none;
}

.consulta-item:hover {
  background-color: #FFC4C4;
  border-radius: 4px;
}
</style>
<script nonce="<%= csp_nonce %>">

  document.addEventListener('DOMContentLoaded', function () {
    const labels = <%= raw(@org_donut_labels.to_json) %>;
    const values = <%= raw(@org_donut_values.to_json) %>;

    const seriesData = labels.map((name, i) => ({ name, y: values[i] }));

    window.orgDonutChart = Highcharts.chart('donut-organizacion', {
      chart: {
        type: 'pie',
        backgroundColor: 'transparent',
        spacing: [10, 0, 0, 0]
      },
      title: { text: null },
      credits: { enabled: false },
      exporting: { enabled: false },

			tooltip: {
			  backgroundColor: 'white',
			  borderColor: '#e0e0e0',
			  style: { color: '#33333C' },
			  formatter: function () {
			    const pct = Highcharts.numberFormat(this.percentage, 1);
			    const y   = Highcharts.numberFormat(this.y, 0, '.', ','); // coma miles
			    return `<b>${this.point.name}</b><br><b>${pct}%</b> (${y})`;
			  }
			},
      plotOptions: {
        pie: {
          innerSize: '40%',
          dataLabels: {
            enabled: true,
            format: '{point.percentage:.1f}%',
            style: { color: '#ffffff', fontWeight: '600', textOutline: 'none', fontSize: '14px'},
            distance: -30
          },
          showInLegend: true
        }
      },

      legend: {
        align: 'right',
        verticalAlign: 'middle',
        layout: 'vertical',
        itemStyle: { color: '#33333C', fontWeight: '600' }
      },

      colors: ['#fbbc04', '#46bdc6', '#34a853', '#ef4e50', '#adacac'],

      series: [{
        name: 'Miembros',
        data: seriesData
      }]
    });
  });
  window.addEventListener('load', function () {
    var el = document.getElementById('grafico-uso-consultas');
    if (!el) return;

    var chart = Highcharts.chart('grafico-uso-consultas', {
      chart: { type: 'pie', height: 160, margin: 0, style: { fontFamily: 'Poppins' } },
      title: false,
      credits: false,
      exporting: { enabled: false },
      legend: { enabled: false },
      plotOptions: { pie: { allowPointSelect: true, cursor: 'pointer', dataLabels: { enabled: false }, showInLegend: true, innerSize: '40%', states: { inactive: { opacity: 1 } } } },
      series: [{
        data: [
          { name: 'Disponibles', y: <%= @suscription[:points] - @queries_info[:total] %>, color: '#E0E0E3', showInLegend: true },
          { name: 'T√∫', y: <%= @queries_info[:usuario] %>, color: '#00B894', showInLegend: true },
          { name: 'Otros usuarios de <%= @user.member.organization.name %>', y: <%= @queries_info[:organizacion] %>, color: '#0984E3', showInLegend: true }
        ],
        tooltip: { headerFormat: '<span style="font-size:12px; color:#454157">{point.key}</span><br>', pointFormat: '<span style="font-size:13px"><b>{point.y} consultas</b></span>' }
      }]
    });

    // Fuerza recalcular tama√±o 2 veces (por fonts/animaciones)
    setTimeout(function(){ if (chart) chart.reflow(); }, 50);
    setTimeout(function(){ if (chart) chart.reflow(); }, 250);
  });

  document.addEventListener('DOMContentLoaded', function () {
    const categories = <%= raw(@hits_year_categories.to_json) %>;
    const data       = <%= raw(@hits_year_data.to_json) %>;

    window.docsByYearChart = Highcharts.chart('hits-por-anio', {
      chart: {
        type: 'column',
        backgroundColor: 'transparent',
        spacing: [10, 0, 0, 0]
      },
      title: { text: null },
      credits: { enabled: false },
      legend: { enabled: false },

      exporting: { enabled: false },  // üëà quita bot√≥n de descargas

      xAxis: {
        categories: categories,
        labels: { style: { color: '#33333C', fontSize: '12px' } },
        lineColor: '#e0e0e0',
        tickColor: '#e0e0e0'
      },

      yAxis: {
        title: { text: null },
        labels: { enabled: false },   // üëà quita etiquetas del eje vertical
        gridLineColor: '#eeeeee'
      },

      tooltip: {
        backgroundColor: 'white',
        borderColor: '#e0e0e0',
        style: { color: '#33333C' },
        pointFormat: '<b>{point.y}</b> documentos'
      },

      plotOptions: {
        column: {
          borderWidth: 0,
          borderRadius: 2,
          pointPadding: 0.06,
          groupPadding: 0.1
        }
      },

      series: [{
        name: 'Documentos',
        data: data,
        color: '#46bdc6'
      }]
    });
  });

   document.addEventListener('DOMContentLoaded', function () {
    // cuando se abre/cierra cualquier collapsible
    $(document).on('click', '.collapsible-header', function () {
      setTimeout(function () {
        if (window.orgDonutChart) window.orgDonutChart.reflow();
        if (window.docsByYearChart) window.docsByYearChart.reflow();
        if (window.mxStateMapChart) window.mxStateMapChart.reflow();
      }, 250); // deja que Materialize termine la animaci√≥n
    });

    // cuando cambias de tab (Materialize)
    const tabsEl = document.getElementById('queries-tabs');
    if (tabsEl && M && M.Tabs) {
      const instance = M.Tabs.getInstance(tabsEl);
      if (instance) {
        const original = instance.options.onShow;
        instance.options.onShow = function () {
          if (original) original.apply(this, arguments);
          setTimeout(function () {
            if (window.orgDonutChart) window.orgDonutChart.reflow();
            if (window.docsByYearChart) window.docsByYearChart.reflow();
            if (window.mxStateMapChart) window.mxStateMapChart.reflow();
          }, 50);
        };
      }
    }
  });
</script>

<script nonce="<%= csp_nonce %>">
  $(document).ready(function () {
    var el = document.getElementById('members-state-map');
    if (!el) return;

    var containerWidth = $('#members-state-map').width() || 300;
		var mapHeight = Math.max(260, Math.min(420, Math.floor(containerWidth * 1.15)));

    var data = [
      <% @members_by_state.each do |(code, name), total| %>
        { name: "<%= j(name.to_s) %>", value: <%= total.to_i %>, code: "<%= j(code.to_s) %>" },
      <% end %>
    ];

    Highcharts.getJSON('/maps/national_map.json', function (geojson) {
      Highcharts.mapChart('members-state-map', {

				chart: {
				  map: geojson,
				  height: mapHeight,
				  spacing: [0, 0, 0, 0],
				  margin: [0, 0, 0, 0],
				  style: { fontFamily: 'Poppins' }
				},

        title: false,
        credits: false,
        exporting: { enabled: false }, // consistente :contentReference[oaicite:2]{index=2}
        legend: false,
        mapNavigation: { enabled: false },

				colors: ['#E4F5F7', '#8FD8DE', '#46BDC6', '#1F7E85'],
				colorAxis: {
				  dataClassColor: 'category',
				  dataClasses: (function () {
				    const vals = data.map(d => d.value || 0);
				    const max = Math.max.apply(null, vals);

				    // umbrales proporcionales para que funcione con cifras grandes
				    const b1 = Math.max(1, Math.ceil(max * 0.10));
				    const b2 = Math.max(b1 + 1, Math.ceil(max * 0.30));

				    return [
				      { to: 0 },
				      { from: 1, to: b1 },
				      { from: b1, to: b2 },
				      { from: b2 }
				    ];
				  })()
				},

        series: [{
          data: data,
          joinBy: 'name',
          name: 'Personas f√≠sicas',
          borderColor: 'white',
          borderWidth: 1,
          nullColor: '#bdbdbd',
          states: {
            hover: { color: '#ffffff', borderColor: '#424242' }
          },
          dataLabels: {
            enabled: true,
            format: '{point.properties.postal}'
          }
        }],

        tooltip: {
          headerFormat: '<span style="font-size:12px; color:#454157">{point.key}</span><br>',
          pointFormatter: function () {
            return '<span style="font-size:16px; color:#454157"><b>' +
              Highcharts.numberFormat(this.value || 0, 0, '.', ',') +
              '</b></span><br>';
          }
        }
      });
    });
  });
</script>
<script nonce="<%= csp_nonce %>">
  document.addEventListener('DOMContentLoaded', function () {
    const tabsEl = document.getElementById('queries-tabs');
    if (!tabsEl || !M || !M.Tabs) return;

    const inst = M.Tabs.getInstance(tabsEl);
    if (!inst) return;

    const original = inst.options.onShow;
    inst.options.onShow = function (content) {
      if (original) original.apply(this, arguments);

      if (content && content.id === 'tab-historial') {
        // fuerza recalculo de layout (sin ‚Äúbrincos‚Äù)
        content.style.display = 'flex';
        void content.offsetHeight;
      }
    };
  });
</script>

<script nonce="<%= csp_nonce %>">
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form[action="/datasets/members_query"]');

    if (form) {
      form.addEventListener('keydown', function (event) {
        if (event.key === "Enter") {
          // Verifica si el bot√≥n est√° visible antes de permitir enviar
          const sendButton = form.querySelector('button[type="submit"], input[type="submit"], .sendmagicbutton');
          const visible = sendButton && sendButton.offsetParent !== null;

          if (!visible) {
            event.preventDefault();
          }
        }
      });
    }
  });
</script>

<script nonce="<%= csp_nonce %>">
  window.nameFrequencies = <%= raw @names_data.to_json %>;
</script>
<div class="row">
	<br>
	<div class="col l4 offset-l1 m5 s12">
		<div class="info-box inline-block">
			<h5 class="h5-no-margin">Panel de consulta</h5>
			<h6 class="h5-no-margin">Lantia Compliance</h6>
			<%# <h6 class="h5-no-margin"><a href="/docs/compliance">Ver documentaci√≥n</a></h6> %>
			<div class="col s12 small-break"></div>

			<div>			
				<a href="/docs/compliance">
				<div class="info-box inline-block valign">
						<i class="small material-icons paletton-red-text right-min-margin">info</i>
				</div>
				<div class="info-box inline-block valign">
						<h6 style="font-weight: 300; color: #ef4e50; margin-top: 8px; padding-bottom: 10px;">DOCUMENTACI√ìN</h6>
				</div>
				</a>
			</div>

<div>
  <% if @user.api_key.blank? %>
    <a href="#api-key-modal" class="modal-trigger">
      <div class="info-box inline-block valign">
        <i class="small material-icons paletton-red-text right-min-margin">code</i>
      </div>
      <div class="info-box inline-block valign">
        <h6 style="font-weight: 300; color: #ef4e50; margin-top: 8px; padding-bottom: 10px;">
          Generar API KEY
        </h6>
      </div>
    </a>

	<% else %>
	  <div class="info-box inline-block valign">
	    <div id="api-key-container" style="height: 50px; display: flex; align-items: center; gap: 10px; padding-bottom: 20px;">
	      <a href="#!" id="reveal-api-key" style="display: flex; align-items: center; gap: 6px;">
	        <i class="small material-icons paletton-red-text">code</i>
	        <h6 style="font-weight: 300; color: #ef4e50; margin: 0;">Ver tu API key</h6>
	      </a>
	    </div>
				<div id="api-key-visible" style="display: none; height: 50px; align-items: center; gap: 10px; padding-bottom: 20px; justify-content: space-between;">
				  <div style="display: flex; align-items: center; gap: 10px;">
				    <a href="#!" id="copy-api-key">
				      <i class="small material-icons paletton-red-text">content_copy</i>
				    </a>
				    <h6 style="font-weight: 300; color: #ef4e50; margin: 0;">
				      Tu API key:
				    </h6>
				    <span id="api-key-value" style="font-weight: 500; color: #000;">
				      <%= @user.api_key %>
				    </span>
				  </div>
				  <a href="#!" id="hide-api-key">
				    <i class="material-icons paletton-red-text">close</i>
				  </a>
				</div>
	  </div>

	  <script nonce="<%= csp_nonce %>">
	    document.addEventListener('DOMContentLoaded', function () {
	      const revealBtn = document.getElementById('reveal-api-key');
	      const visibleDiv = document.getElementById('api-key-visible');
	      const container = document.getElementById('api-key-container');

	      if (revealBtn && visibleDiv && container) {
	        revealBtn.addEventListener('click', function (e) {
	          e.preventDefault();
	          container.style.display = 'none';
	          visibleDiv.style.display = 'flex';
	        });
	      }

	      const copyBtn = document.getElementById('copy-api-key');
	      const valueEl = document.getElementById('api-key-value');

	      if (copyBtn && valueEl) {
	        copyBtn.addEventListener('click', function (e) {
	          e.preventDefault();
	          const text = valueEl.textContent.trim();
	          navigator.clipboard.writeText(text).then(function () {
	            M.toast({html: 'API key copiado'});
	          });
	        });
	      }

				const hideBtn = document.getElementById('hide-api-key');

				if (hideBtn) {
				  hideBtn.addEventListener('click', function (e) {
				    e.preventDefault();
				    document.getElementById('api-key-visible').style.display = 'none';
				    document.getElementById('api-key-container').style.display = 'flex';
				  });
				}

	    });
	  </script>
	<% end %>

</div>


<!-- API KEY MODAL -->
<div id="api-key-modal" class="modal">
  <div class="modal-content">
    <%= image_tag "optimized_logo.jpg", class: "modal-logo" %>
    <p class="p20 slim">
      La API Key NO es necesaria para realizar consultas manuales en esta p√°gina. Es una credencial personal para autenticar solicitudes automatizadas en la API de Lantia Compliance. 
     </p>
     <br>
    <p class="p20 slim">
      Las consultas autom√°ticas se contabilizan igual que las consultas manuales.  
			Para m√°s informaci√≥n consulta la documentaci√≥n.
    </p>
    <br>
    <p class="p20 slim">
    	Si contin√∫as, se generar√° un API Key.
    	No compartas tu API Key ni la copies en repositorios de acceso p√∫blico.
    </p>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">
      <i class="material-icons small">close</i>
    </a>

    <!-- Bot√≥n continuar: por ahora deja el action como placeholder -->
    <form action="<%= generate_user_api_key_path %>" method="post" style="display:inline;">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <button type="submit" class="waves-effect waves-light btn" style="margin-right: 10px;">
        Continuar
      </button>
    </form>
  </div>
</div>

<script nonce="<%= csp_nonce %>">
  document.addEventListener('DOMContentLoaded', function () {
    var els = document.querySelectorAll('.modal');
    M.Modal.init(els);
  });
</script>


		</div>	    
		<div class="card paletton-grey">
			<div class="card-content white-text">
				<div class="row">
					<div class="col s12">
						<span class="valign-wrapper left-extra-margin">
							<strong>NUEVA CONSULTA</strong>
						</span>
					</div>
				</div>
				<form action="/datasets/members_query" method="post">
					<input type="hidden" name="authenticity_token" value="<%=form_authenticity_token%>">
					<div class="row">
						<div class="col s11 valign-wrapper">
							<input class="input-padding white query-field" name="query[firstname]" type="text"  autocomplete="off">
							 <i class="material-icons white-text small" style="display: none; margin-left: 10px">check</i>
						</div>
							
						<div class="label-row">
							<div class="col s10 offset">
								<label class="white-text">NOMBRE(S)</label>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col s11 valign-wrapper">
							<input class="input-padding white query-field" name="query[lastname1]" type="text" autocomplete="off">
							<i class="material-icons white-text small" style="display: none; margin-left: 10px">check</i>
						</div>
						<div class="label-row">
							<div class="col s10 offset">
								<label class="white-text">APELLIDO PATERNO</label>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col s11 valign-wrapper">
							<input class="input-padding white query-field" name="query[lastname2]" type="text" autocomplete="off">
							<i class="material-icons white-text small" style="display: none; margin-left: 10px">check</i>
						</div>
						<div class="label-row">
							<div class="col s8">
								<label class="white-text">APELLIDO MATERNO</label>
							</div>
						</div>
					</div>
					<div class="divider"></div>
					<div class="row">
						<div class="col s12">
							<div style="margin: 20px 0px 0px 20px">
								<div style="display: inline-block;">Probabilidad de hom√≥nimos: </div>
								<div id="name-warning" class="valign" style="display: inline-block; font-weight: 800;"></div>
							</div>
						</div>
					</div>
					<input type="hidden" name="query[homo_score]" id="homo_score_input">
					<div class="divider"></div>
					<div class="row">
							<div class="card-action">
								<div class="right" style="height: 10px">
									<%= render "shared/sendmagicbutton" %>
								</div>
							</div>
					</div>
				</form>
			</div>
		</div>
	</div>
<div class="col s12 m7 l5 queries-panel">
  <div id="outcome-card" class="card z-depth-1 queries-panel__card" style="background-color: white;">

    <!-- Tabs header -->
    <div class="card-content" style="padding-bottom:0;">
      <ul id="queries-tabs" class="tabs" style="background: transparent;">
        <li class="tab col s6"><a class="active" href="#tab-historial">consultas</a></li>
        <li class="tab col s6"><a href="#tab-bd">Base de datos</a></li>
      </ul>
    </div>

    <!-- Tabs content -->
    <div class="card-content queries-panel__content" style="color:#33333C; padding-right:8px; padding-bottom:0; padding-top:0;">

      <!-- TAB 1: Historial (todo lo que ya ten√≠as) -->
      <div id="tab-historial" class="queries-panel__content" style="height:100%; min-height:0;">
        <div class="queries-panel__scroll">
          <table id="outcome-table" class="animate__animated animate__fadeIn" style="font-size: 14px; width: 100%;">
            <tbody>
              <tr style="border-bottom: none;">
                <td colspan="2" style="font-weight: bold; padding-bottom: 15px;">
                  <%= @user.member.organization.name.upcase %>
                </td>
              </tr>
              <tr style="border-bottom: 2px solid #33333C;">
                <td>
                  <p>Suscripci√≥n: <span style="font-weight: 800;"><%= @suscription[:level] %></span></p>
                  <br>
                  <p>
                    <%= User.find(session[:user_id]).member.organization.name %> tiene
                    <%= @suscription[:points] - @queries_info[:total] %> consulta<%= @suscription[:points] - @queries_info[:total] == 1 ? '' : 's' %> disponibles para usarse antes del
                    <%= l(@period_end, format: "%-d de %B de %Y") %>.
                  </p>
                </td>
                <td>
                  <div id="grafico-uso-consultas" style="height: 200px; max-width: 200px; margin: 0 auto;"></div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="section">
            <p>Tus consultas del periodo (<%= l(@period_start.to_date, format: "%-d %b %Y") %> ‚Äì <%= l(@period_end.to_date, format: "%-d %b %Y") %>)</p>

            <ul class="collapsible popout" style="border: none;" data-collapsible="accordion">
              <% @queries_por_dia.sort.reverse.each do |fecha, queries| %>
                <li>
                  <div class="collapsible-header" style="color: #33333C">
                    <div style="font-weight: 600"><%= fecha.strftime("%d/%m/%Y") %></div>
                    <div class="right-align" style="width: 120px;">
                      <span><%= queries.size %> consulta<%= queries.size > 1 ? 's' : '' %></span>
                    </div>
                  </div>

                  <div class="collapsible-body" style="padding: 15px;">
                    <ul style="margin: 0; padding-left: 18px;">
                      <% queries.each do |q| %>
                        <% clave = "#{@user.member.firstname.first}#{@user.member.lastname1.first}-#{@user.member.organization_id}-#{q.id}" %>
                        <a href="<%= redirect_to_outcome_path(q.id) %>">
                          <li class="consulta-item" style="display: flex; align-items: center; margin-bottom: 6px;">
                            <button class="btn-flat transparent z-depth-0 clave-boton" style="min-width: 110px; font-weight: 500; margin-right: 12px; padding: 0 8px;">
                              <%= clave %>
                            </button>
                            <span><%= q.query_label rescue "[encrypted]" %></span>
                          </li>
                        </a>
                      <% end %>
                    </ul>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
        <!-- paginaci√≥n fuera del scroll (solo para Historial) -->
        <% if @total_pages.to_i > 1 %>
          <div class="queries-panel__pagination">
            <div class="center-align" style="margin-top: 0;">
              <ul class="pagination" style="margin: 0;">
                <% prev_page = [@qpage - 1, 1].max %>
                <% next_page = [@qpage + 1, @total_pages].min %>

                <li class="<%= 'disabled' if @qpage <= 1 %>">
                  <%= link_to url_for(params.permit!.to_h.merge(qpage: prev_page)) do %>
                    <i class="material-icons">chevron_left</i>
                  <% end %>
                </li>

                <% start_page = [@qpage - 2, 1].max %>
                <% end_page   = [@qpage + 2, @total_pages].min %>

                <% (start_page..end_page).each do |p| %>
                  <li class="<%= p == @qpage ? 'active' : 'waves-effect' %>">
                    <%= link_to p, url_for(params.permit!.to_h.merge(qpage: p)) %>
                  </li>
                <% end %>

                <li class="<%= 'disabled' if @qpage >= @total_pages %>">
                  <%= link_to url_for(params.permit!.to_h.merge(qpage: next_page)) do %>
                    <i class="material-icons">chevron_right</i>
                  <% end %>
                </li>
              </ul>
            </div>
          </div>
        <% end %>
      </div>


			<div id="tab-bd" style="padding-top: 8px; color:#33333C;">
			  <br>
				<table class="animate__animated animate__fadeIn" style="font-size: 16px; width: 100%; line-height: 1.2;">
				  <tbody>
				    <tr style="border-bottom: none;">
				      <th style="text-align:left; width: 190px; padding: 2px 6px 2px 8px; color:#33333C;">
				        Personas f√≠sicas:
				      </th>
				      <td style="padding: 2px 0; color:#33333C;">
				        <%= number_with_delimiter(@targetMembers.count) %>
				      </td>
				    </tr>

				    <tr style="border-bottom: none;">
				      <th style="text-align:left; width: 190px; padding: 2px 6px 2px 8px; color:#33333C;">
				        √öltima actualizaci√≥n:
				      </th>
				      <td style="padding: 2px 0; color:#33333C;">
				        <%= @last_updated_at ? @last_updated_at.in_time_zone("America/Mexico_City").strftime("%d/%m/%Y %H:%M") : "No disponible" %>
				      </td>
				    </tr>
				  </tbody>
				</table>
				<div style="border-top: 1px solid #e0e0e0; margin: 10px 0 8px 0;"></div>
				<ul class="collapsible popout" style="border: none; margin-top: 12px;">  
				  <li class="active" id="coll-state">
				    <div class="collapsible-header" style="color:#33333C; font-weight:600; font-size:16px;">
				      Distribuci√≥n por estado
				    </div>
				    <div class="collapsible-body" style="padding: 12px 0 0 0;">
				      <div id="members-state-map" style="max-height: 400px; width: 100%;"></div>
				    </div>
				  </li>
				  <li id="coll-org">
				    <div class="collapsible-header" style="color:#33333C; font-weight:600; font-size:16px;">
				      Distribuci√≥n por organizaci√≥n
				    </div>
				    <div class="collapsible-body" style="padding: 12px 0 0 0;">
				      <div id="donut-organizacion" style="height: 260px; width: 100%;"></div>
				    </div>
				  </li>
				  <li id="coll-year">
				    <div class="collapsible-header" style="color:#33333C; font-weight:600; font-size:16px;">
				      Documentos por a√±o
				    </div>
				    <div class="collapsible-body" style="padding: 12px 0 0 0;">
				      <div id="hits-por-anio" style="height: 240px; width: 100%;"></div>
				    </div>
				  </li>
				</ul>
			</div>
    </div>
  </div>
</div>


</div>

<!-- PASSWORD ERROR MODAL -->
<% if @password_error %>
	<div id="password-error-modal" class="modal">
		<div class="modal-content">
			<%= image_tag "optimized_logo.jpg", :class => "modal-logo"%>
			<p class="p20 slim">Lo sentimos. El correo o la contrase√±a no corresponden a ning√∫n usuario registrado.</p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close waves-effect waves-green btn-flat"><i class="material-icons small">close</i></a>
		</div>
	</div>
<% end %>

<!-- PLAN LIMIT MODAL -->
<% if @plan_limit_error %>
  <div id="plan-limit-modal" class="modal">
    <div class="modal-content">
      <%= image_tag "optimized_logo.jpg", :class => "modal-logo"%>
      <p class="p20 slim">
        Has rebasado el l√≠mite de consultas de tu plan.
        Para contratar consultas adicionales escribe a
        <b>contacto@lantiaintelligence.com</b>.
      </p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">
        <i class="material-icons small">close</i>
      </a>
    </div>
  </div>

  <script nonce="<%= csp_nonce %>">
    document.addEventListener('DOMContentLoaded', function () {
      var el = document.getElementById('plan-limit-modal');
      if (el) {
        var instance = M.Modal.init(el);
        instance.open();
      }
    });
  </script>
<% end %>