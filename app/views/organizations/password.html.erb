<%= render 'shared/flash' %>
	<% if session[:subscription_expired] %>
	  <% exp_date = begin
	      Date.parse(session[:subscription_expired_on].to_s)
	    rescue
	      nil
	    end %>

	  <div class="card-panel red lighten-5 red-text text-darken-4" style="margin: 12px 0;">
	    <% if exp_date %>
	      <strong>Tu suscripción expiró el <%= I18n.l(exp_date, format: "%-d de %B de %Y") %>.</strong>
	    <% else %>
	      <strong>Tu suscripción expiró.</strong>
	    <% end %>
	    <br>
	    <strong>Para reactivarla por favor escríbenos a contacto@lantiaintelligence.com</strong>.
	  </div>

	  <% session.delete(:subscription_expired) %>
	  <% session.delete(:subscription_expired_on) %>
	<% end %>
<div class="row">
	<br>
	<div class="col l5 m8 s12">
		<div class="card paletton-grey">
			<div class="card-content white-text">
				<div class="row">
					<div class="col s12">
						<%= render "shared/lantialogo2" %>
					</div>
				</div>
				<div class="row">
					<div class="col s12">
						<span class="card-title center">Validación de usuario</span>
					</div>
				</div>
				<form action="/organizations/login" method="post">
					<input type="hidden" name="authenticity_token" value="<%=form_authenticity_token%>">
					<div class="row">
						<div class="col s12 valign-wrapper">
							<i class="material-icons prefix small">email</i>
				<!-- 		</div>
						<div class="input-field col s8"> -->
							<input class="input-padding white" name="user[mail]" type="text" placeholder="Correo">
						</div>
					</div>
					<div class="row">
						<div class="col s12 valign-wrapper">
							<i class="material-icons prefix small">vpn_key</i>
							<input class="input-padding white" id="password-field" name="user[password]" type="password" placeholder="Contraseña">
							<i class="material-icons grey-text text-darken-2"
   							id="toggle-pass"
   							style="margin-left: -40px; cursor: pointer;">visibility</i>
						</div>
					</div>
					<div class="row">
						<div class="col s12">
							<%# <div class="card-action"> %>
								<div class="input-field valign-wrapper right short-row" style="margin-right: 70px;">
									<button class="btn-floating teal lighten-5" type="submit"><i class="material-icons grey-text text-darken-3">send</i></button>
								</div>
							<%# </div> %>
						</div>
					</div>
					<div class="divider"></div>
					<div class="row valign-wrapper">
						<div class="col s12">
							<div class="card-action">
								<!-- Link a modal de “Olvidé mi contraseña” -->
								<div class="input-field col s8" style="margin-bottom:-10px">
								  
<a href="#forgot-modal"
   id="forgot-link"
   class="modal-trigger"
   style="color: #ee6e73; font-size: 15px; font-weight: 600;">
  Olvidé mi contraseña
</a>


								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- PASSWORD ERROR MODAL -->
<% if @password_error %>
	<div id="password-error-modal" class="modal">
		<div class="modal-content">
			<%= image_tag "optimized_logo.jpg", :class => "modal-logo"%>
			<p class="p20 slim">Lo sentimos. El correo o la contraseña no corresponden a ningún usuario registrado.</p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close waves-effect waves-green btn-flat"><i class="material-icons small">close</i></a>
		</div>
	</div>
<% end %>

<!-- FORGOT PASSWORD MODAL -->
<div id="forgot-modal" class="modal">
  <div class="modal-content">
    <%= image_tag "optimized_logo.jpg", class: "modal-logo" %>
    <p class="p20 slim">Escribe tu correo. Si existe una cuenta, te enviaremos un enlace para restablecer la contraseña.</p>
		<form id="forgot-form">
		  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <div class="input-field">
        <input id="forgot-email" type="email" placeholder="Correo" required>
      </div>
      <div class="input-field">
        <button id="forgot-submit" class="btn waves-effect">Enviar enlace</button>
      </div>
      <div id="forgot-msg" class="grey-text text-darken-1" style="margin-top:6px;"></div>
    </form>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat"><i class="material-icons small">close</i></a>
  </div>
</div>


<script nonce="<%= csp_nonce %>">
  // (1) Toggle de visibilidad de contraseña sin atributos inline
  function togglePasswordVisibility(e) {
    var passwordField = document.getElementById('password-field');
    var icon = e && (e.currentTarget || e.target);
    if (!passwordField || !icon) return;
    if (passwordField.type === 'password') {
      passwordField.type = 'text';
      icon.textContent = 'visibility_off';
    } else {
      passwordField.type = 'password';
      icon.textContent = 'visibility';
    }
  }

  // (2) Envío del reset por fetch (tu lógica original)
  function submitReset(e) {
    e.preventDefault();
    var email = document.getElementById('forgot-email').value.trim();
    var btn   = document.getElementById('forgot-submit');
    var msg   = document.getElementById('forgot-msg');
    if (!email) { msg.textContent = 'Ingresa un correo válido.'; return; }

    var tokenMeta = document.querySelector('meta[name="csrf-token"]');
    var csrfToken = tokenMeta ? tokenMeta.content : '';

    btn.disabled = true; msg.textContent = 'Enviando…';
    fetch('/password_resets', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRF-Token': csrfToken
      },
      body: 'email=' + encodeURIComponent(email)
    }).then(function(res) {
      msg.textContent = (res.status === 204)
        ? 'Si el correo existe, enviamos un enlace de restablecimiento.'
        : 'Solicitud recibida (' + res.status + '). Revisa tu correo.';
    }).catch(function() {
      msg.textContent = 'Hubo un problema. Intenta más tarde.';
    }).finally(function() { btn.disabled = false; });
  }

  // (3) Enlazar eventos al cargar el DOM
  document.addEventListener('DOMContentLoaded', function() {
    var eye = document.getElementById('toggle-pass');
    if (eye) eye.addEventListener('click', togglePasswordVisibility);

    var forgotLink = document.getElementById('forgot-link');
    if (forgotLink) forgotLink.addEventListener('click', function() {
      var v  = document.querySelector('input[name="user[mail]"]');
      var fe = document.getElementById('forgot-email');
      if (v && v.value && fe) fe.value = v.value;
    });

    var form = document.getElementById('forgot-form');
    if (form) form.addEventListener('submit', submitReset);
  });
</script>