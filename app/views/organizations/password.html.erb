<div class="row">
	<br>
	<div class="col l5 m8 s12">
		<div class="card paletton-grey">
			<div class="card-content white-text">
				<div class="row">
					<div class="col s12">
						<%= render "shared/lantialogo2" %>
					</div>
				</div>
				<div class="row">
					<div class="col s12">
						<span class="card-title center">Validación de usuario</span>
					</div>
				</div>
				<form action="/organizations/login" method="post">
					<input type="hidden" name="authenticity_token" value="<%=form_authenticity_token%>">
					<div class="row">
						<div class="col s12 valign-wrapper">
							<i class="material-icons prefix small">email</i>
				<!-- 		</div>
						<div class="input-field col s8"> -->
							<input class="input-padding white" name="user[mail]" type="text" placeholder="Correo">
						</div>
					</div>
					<div class="row">
						<div class="col s12 valign-wrapper">
							<i class="material-icons prefix small">vpn_key</i>
							<input class="input-padding white" id="password-field" name="user[password]" type="password" placeholder="Contraseña">
							<i class="material-icons grey-text text-darken-2" style="margin-left: -40px; cursor: pointer;" onclick="togglePasswordVisibility()">visibility</i>
						</div>
					</div>
					<div class="row">
						<div class="col s12">
							<%# <div class="card-action"> %>
								<div class="input-field valign-wrapper right short-row" style="margin-right: 70px;">
									<button class="btn-floating teal lighten-5" type="submit"><i class="material-icons grey-text text-darken-3">send</i></button>
								</div>
							<%# </div> %>
						</div>
					</div>
					<div class="divider"></div>
					<div class="row valign-wrapper">
						<div class="col s12">
							<div class="card-action">
								<!-- Link a modal de “Olvidé mi contraseña” -->
								<div class="input-field col s8" style="margin-bottom:-10px">
								  <a href="#forgot-modal" style="color: #ee6e73; font-size: 15px; font-weight: 600;" class="modal-trigger" onclick="
								    var v=document.querySelector('input[name=&quot;user[mail]&quot;]').value;
								    var fe=document.getElementById('forgot-email'); if(v && fe) fe.value=v;
								  ">Olvidé mi contraseña</a>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- PASSWORD ERROR MODAL -->
<% if @password_error %>
	<div id="password-error-modal" class="modal">
		<div class="modal-content">
			<%= image_tag "optimized_logo.jpg", :class => "modal-logo"%>
			<p class="p20 slim">Lo sentimos. El correo o la contraseña no corresponden a ningún usuario registrado.</p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close waves-effect waves-green btn-flat"><i class="material-icons small">close</i></a>
		</div>
	</div>
<% end %>

<!-- FORGOT PASSWORD MODAL -->
<div id="forgot-modal" class="modal">
  <div class="modal-content">
    <%= image_tag "optimized_logo.jpg", class: "modal-logo" %>
    <p class="p20 slim">Escribe tu correo. Si existe una cuenta, te enviaremos un enlace para restablecer la contraseña.</p>

    <form onsubmit="submitReset(event)">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <div class="input-field">
        <input id="forgot-email" type="email" placeholder="Correo" required>
      </div>
      <div class="input-field">
        <button id="forgot-submit" class="btn waves-effect">Enviar enlace</button>
      </div>
      <div id="forgot-msg" class="grey-text text-darken-1" style="margin-top:6px;"></div>
    </form>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat"><i class="material-icons small">close</i></a>
  </div>
</div>


<script>
  function togglePasswordVisibility() {
    const passwordField = document.getElementById("password-field");
    const icon = event.target;
    if (passwordField.type === "password") {
      passwordField.type = "text";
      icon.textContent = "visibility_off";
    } else {
      passwordField.type = "password";
      icon.textContent = "visibility";
    }
  }
</script>

<script>
  // Inicializa modales (Materialize)
  document.addEventListener('DOMContentLoaded', function() {
    try { if (window.M && M.Modal) M.Modal.init(document.querySelectorAll('.modal')); } catch(e) {}
  });

  // Envía POST /password_resets sin salir de la página
  function submitReset(e) {
    e.preventDefault();
    var email = document.getElementById('forgot-email').value.trim();
    var btn   = document.getElementById('forgot-submit');
    var msg   = document.getElementById('forgot-msg');
    if (!email) { msg.textContent = 'Ingresa un correo válido.'; return; }

    btn.disabled = true; msg.textContent = 'Enviando…';
    fetch('/password_resets', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: 'email=' + encodeURIComponent(email)
    }).then(function() {
      msg.textContent = 'Si el correo existe, enviamos un enlace de restablecimiento.';
    }).catch(function() {
      msg.textContent = 'Hubo un problema. Intenta más tarde.';
    }).finally(function() {
      btn.disabled = false;
    });
  }
</script>